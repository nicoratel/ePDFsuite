"""
Lobato parametrization for electron and X-ray scattering factors.

Based on:
Lobato, I., & Van Dyck, D. (2014). An accurate parameterization for scattering 
factors, electron densities and electrostatic potentials for neutral atoms that 
obey all physical constraints. Acta Crystallographica Section A, 70(6), 636-649.

This is a simplified standalone implementation extracted from abTEM to avoid
heavy dependencies on visualization libraries.
"""

import numpy as np
import json
from pathlib import Path


# Lobato parameters for all elements (H to Lr)
LOBATO_PARAMETERS = {"H": [[0.00647384848835291, -0.490192576780229, 0.573284160390876, -0.37940330148399, 0.554426474774079], [2.78519885379148, 2.77620428330644, 2.77538591050625, 2.76759302867258, 2.76511897642927]], "He": [[3.05745116099835, -62.0044779127325, 64.0055537084614, -5.0013257854278, 0.151798828700526], [1.08967248726078, 0.939838798143121, 0.925289034386265, 0.82294749870865, 0.577393110675402]], "Li": [[3.92622272886147, -4.54861962639998, 2.19335312878658, 0.0699451265033965, 0.00209864224851937], [8.1427601351728, 4.98941077007855, 4.1442899923941, 0.40192231506568, 0.156479034719823]], "Be": [[3.39824970557054, -1.90866886095696, 0.0390702117539227, -0.0111631010210714, 0.00946204465357523], [4.44270178622409, 3.32451542526423, 0.189772880348214, 0.0871918614644603, 0.082780906004134]], "B": [[1.47279248639329, -0.401933042199387, 0.305998956982689, 0.0196144217173168, 0.0009771771060882], [3.74974048281819, 0.588066536139673, 0.515639613103011, 0.121377570080603, 0.0680982412160313]], "C": [[124.466088621343, -220.352857078963, 195.235352280479, -98.1079361269799, 0.0142023041213623], [2.42120849256005, 2.30537943752425, 2.04851932106564, 1.93352552917547, 0.0768976818478339]], "N": [[58.1327150702556, -114.763378784546, 93.3549299107299, -39.8690763849669, 0.0215700032118756], [2.31502530369188, 2.09840016655978, 1.83955595457208, 1.72395187979574, 0.090891825962204]], "O": [[64.5899502076819, -146.064374041814, 135.045939163892, -66.7276636313976, 0.0338024648311867], [2.39026708433327, 2.17157331826662, 1.95230048366128, 1.85125862174845, 0.110136774400806]], "F": [[60.3823035142178, -140.707506938109, 134.754811876668, -69.7932810406837, 0.0520076092695076], [2.37179568305584, 2.13854551688833, 1.92346088787394, 1.84331063866095, 0.139087272651092]], "Ne": [[43.7965230931063, -90.1334720287006, 81.8815185424063, -41.0829486782343, 0.0796734863086775], [2.15662993287961, 1.91773936918308, 1.69892068551948, 1.58916072086746, 0.171933476989982]], "Na": [[3.3044763054045, 0.822594842902983, -0.0233641694963869, 0.0213966568869945, 0.000219912851826551], [4.39194075331195, 1.21806768437222, 0.088683862696876, 0.0699652945802031, 0.0362804844604682]], "Mg": [[3.65691479775968, 0.719591738924935, -0.0102251710177569, 0.00866488313754398, 0.000154829328691495], [3.62767646803568, 0.883730095290044, 0.047883889932453, 0.0462196829003806, 0.0304773719863849]], "Al": [[4.29195091726078, 0.630913619250485, 0.00361164308158095, 0.00270193119965662, 0.000126032394038224], [3.05065309289639, 0.684990866085932, 0.0244556559309433, 0.0238993867826084, 0.0263099802755966]], "Si": [[4.85968094940866, 0.561394449408703, 0.0145431655871767, 0.0009024913532876, 0.000102489048055927], [2.62727847221853, 0.544857648093931, 0.0154063793663591, 0.0102124682766804, 0.0224024955005378]], "P": [[5.40015191439996, 0.498516091824388, 0.023901806932648, 0.000358877031654867, 8.373662945979e-05], [2.27668761398699, 0.445479652532336, 0.0110095304925892, 0.00424821405024619, 0.0189779813419913]], "S": [[5.91760647355307, 0.440797012294127, 0.0308823890301067, 0.00013369617768077, 6.740363955729e-05], [1.99198846176055, 0.370035063866042, 0.00787683827099806, 0.00166857990569989, 0.0161281687176813]], "Cl": [[6.42111473643989, 0.385763089042, 0.0356877398933145, 5.082084823394e-05, 5.397959975854e-05], [1.74734552772074, 0.311169893046076, 0.00577346945685622, 0.000644598028127803, 0.0137148009816819]], "Ar": [[6.93032024453537, 0.326677078372127, 0.0385479073622119, 2.192169925815e-05, 4.285068866439e-05], [1.53879789555926, 0.250830506408776, 0.00417959341327926, 0.000257606051095382, 0.0115874096293055]], "K": [[1.78296832478395, 1.8486918881666, 0.137076644636802, 0.0223018493893964, 3.207024311676e-05], [7.82989064481068, 1.82021990028163, 0.193037598969506, 0.00608085951748346, 0.0109825321820066]], "Ca": [[2.70948990653076, 1.69408048969287, 0.0905326267638639, 0.0161481089449398, 2.722949968949e-05], [5.16330537950564, 1.43226682476645, 0.117951494163208, 0.00436639066091938, 0.00935398604621088]], "Sc": [[2.61881027063479, 1.80088813652072, 0.0768181869651341, 0.0127945394169584, 2.457823838095e-05], [4.69178644932653, 1.42088798473997, 0.0968730867621388, 0.00362154172062989, 0.00804961982894652]], "Ti": [[2.60263878948883, 1.83318084036486, 0.0665638887817685, 0.0103878889819765, 2.271092449089e-05], [4.37109968113098, 1.34984564949838, 0.0814086119988494, 0.00308031516098989, 0.0069545978193883]], "V": [[1.95768606398806, 2.23968969208619, 0.0551639894764899, 0.00849862935569082, 2.071509959695e-05], [4.30265806093863, 1.44270669857037, 0.065827881488638, 0.00260997636013551, 0.00601127346059947]], "Cr": [[1.75899056023193, 2.38088193916074, 0.0438968296827843, 0.00690868473027301, 1.872879621652e-05], [4.13734831824453, 1.36779831551963, 0.0515943837093929, 0.00220084326056766, 0.00519904398027823]], "Mn": [[1.60969071001054, 2.48042068103173, 0.0345388085330449, 0.00560084782932423, 1.690172779084e-05], [4.03050775730568, 1.29173327485894, 0.04029856991825, 0.00184939868536853, 0.00449292030172375]], "Fe": [[1.51206031341831, 2.57106698073166, 0.0274214065399098, 0.00455467043881598, 1.524067943278e-05], [3.92982765697046, 1.22636092959783, 0.0316878084076916, 0.00155282327899965, 0.00389125046888656]], "Co": [[1.42717882883948, 2.64961088327082, 0.0213969968024421, 0.00368086035682491, 1.362947743296e-05], [3.81931967892094, 1.16653881636738, 0.0247088072611878, 0.00129524835754069, 0.00336783765136896]], "Ni": [[1.31688564479662, 2.7615314773933, 0.0165124933555611, 0.00295943025862408, 1.218050861689e-05], [3.73001669798516, 1.11803619991152, 0.0192203298767645, 0.00107779532894395, 0.00291871869084653]], "Cu": [[1.29267858223018, 2.77908894066294, 0.0137024990690893, 0.00249346066842296, 1.111821423656e-05], [3.50681023536851, 1.04844134071743, 0.0161388479113485, 0.000931569859738406, 0.00255939019969694]], "Zn": [[1.19888813316093, 2.88673685099476, 0.0111467993764732, 0.00203659569732061, 9.902069736491e-06], [3.36948069026009, 1.00059164169903, 0.0130782113932598, 0.000756870878197468, 0.0022223485732663]], "Ga": [[2.32598223662313, 1.6486353506829, 0.0116267092839099, 0.00177889932398387, 9.08869473896e-06], [2.56764095673568, 0.796827286603668, 0.0118177074766033, 0.000674065061761327, 0.00195965844619765]], "Ge": [[2.63773086824078, 1.41693485206485, 0.0111337099065844, 0.00158754823881082, 8.489854858558e-06], [2.16598935088025, 0.630832766597838, 0.0111109829766084, 0.000616889346113853, 0.00174343945809924]], "As": [[2.91324802821638, 1.1796467847893, 0.0104827069348979, 0.00141810894732071, 7.816088166667e-06], [1.85110062078095, 0.494817064989612, 0.0103099663682421, 0.000560486697476337, 0.00155315876847661]], "Se": [[3.15881302949164, 0.957045764817611, 0.00970925782804419, 0.00126593071226903, 7.273089103993e-06], [1.59863033433925, 0.385070055738936, 0.00949166086314628, 0.000509270076838009, 0.00138488606994104]], "Br": [[3.37746327889825, 0.753406181889889, 0.00892406026997923, 0.00112910056730949, 6.716301097632e-06], [1.39290332950341, 0.296856453663766, 0.00869080766883756, 0.000462056348838313, 0.00123652892800164]], "Kr": [[3.59009847683764, 0.556849879959584, 0.00812638638699991, 0.00100486950850926, 6.221820089959e-06], [1.21885933893866, 0.222889990734621, 0.00791039991051802, 0.000418926882932952, 0.00110497098577321]], "Rb": [[3.18653896039134, 1.39488082068294, 0.0334858341606063, 0.00130854819087879, 6.176181844841e-06], [4.25838346853827, 0.821746072405447, 0.0140862091074876, 0.000608829618113945, 0.00105932866999087]], "Sr": [[2.76766090088488, 1.84949842023071, 0.027090042313551, 0.00112857698997688, 5.734889668267e-06], [4.78119399919991, 1.01064881329024, 0.0109815313914997, 0.000519074398823009, 0.0009871618473766]], "Y": [[2.87063327768963, 1.88682479764764, 0.023162098033803, 0.00101253024074663, 5.489556926092e-06], [4.58073226097302, 0.985965842080564, 0.00914717653929398, 0.00046301085823449, 0.00091806012876676]], "Zr": [[4.31175453406871, 1.49331578039339, 0.281236050128884, 0.00309337738455747, 2.5802444851e-07], [9.4589658051749, 1.33063622845245, 0.156506871444453, 0.00682410523811735, 0.0002498188791107]], "Nb": [[3.11179039113495, 2.20259060945803, 0.27033077491002, 0.00268799194751098, 2.3254948335e-07], [10.6903141343023, 1.65316356158933, 0.145115185718969, 0.0061395635158285, 0.00023224023593767]], "Mo": [[2.83105968432053, 2.34858137489674, 0.245105888429696, 0.00235282108218515, 2.3127083834e-07], [10.435719575895, 1.60482868674597, 0.131696934774606, 0.00554977901383345, 0.0002227474637649]], "Tc": [[2.57179859323352, 2.45633741957203, 0.220658440881371, 0.00205531418012438, 2.3213294779e-07], [10.1643117131377, 1.5344191924455, 0.11913861975411, 0.00501853240882988, 0.00021459037912086]], "Ru": [[2.33230030353946, 2.53578025489049, 0.198208042136026, 0.00176120130460053, 1.9812941155e-07], [9.92167460159959, 1.45585668808788, 0.107682187873349, 0.00447243545654967, 0.0001965747162325]], "Rh": [[2.1135253485947, 2.58636316155013, 0.177063913863686, 0.00149737051003056, 2.0548144556e-07], [9.65913725859762, 1.37106656934329, 0.0970353027584648, 0.00397128509088792, 0.0001913551907378]], "Pd": [[0.642159796182687, 2.97914814426328, 0.16815442600427, 0.00133744213878407, 1.9141096825e-07], [5.97479750263406, 1.43359432541277, 0.0909868401172677, 0.00362410137116162, 0.00018068891441605]], "Ag": [[1.55317216680389, 2.63930364699988, 0.142015486956788, 0.0010085046009976, 1.9463842997e-07], [8.15620235758956, 1.21600887481801, 0.0790098864915873, 0.00296547901363949, 0.00017459309591915]], "Cd": [[61.530785199286, -78.6016741201582, 21.550129260277, 0.137685015664191, 0.00032464493094652], [3.11468102533247, 2.76016983388574, 1.93551312324722, 0.0722468347260293, 0.00117001629624684]], "In": [[4.22232177901524, -26.4121318353202, 27.2852852708746, 0.121617901884138, 0.00030688354637153], [6.07265510403227, 1.64550178959387, 1.52257074939506, 0.0656507914695225, 0.00112093851473035]], "Sn": [[5.14222074642053, -25.4945413762576, 25.7414487548601, 0.111778227592199, 0.00029364738473774], [5.27272636474484, 1.53194959209148, 1.40257525040087, 0.0611685387263086, 0.00107560815394522]], "Sb": [[6.24164031831883, -93.3868724419552, 92.6332875829884, 0.103412692221298, 0.00028184842689439], [4.26984108082687, 1.3940774614025, 1.35566854910434, 0.0572667949652199, 0.00103307954282067]], "Te": [[7.37743301813403, -126.025106931628, 124.128405004095, 0.0959978371818569, 0.00027107221639888], [3.46917757783897, 1.29759810886736, 1.26771067646066, 0.0537771750179423, 0.00099308457702918]], "I": [[9.64400666272123, -122.924435350112, 118.682564816567, 0.0895025947025539, 0.00026127612149048], [2.72645545366544, 1.23723425850866, 1.20062036872249, 0.0506678682285199, 0.0009554378833835]], "Xe": [[15.545174967486, -118.241027856744, 108.009524963197, 0.0836259341992221, 0.00025199186242907], [2.10637340865492, 1.20860376129512, 1.15395270567214, 0.0478189391274824, 0.00091988625759261]], "Cs": [[4.28708739181692, 3.23250665422965, 0.674029533561706, 0.0618908083387697, 0.00023561205295219], [22.6587870798541, 2.23797386470064, 0.368995568664316, 0.0402266575298484, 0.00088376189087804]], "Ba": [[6.24475187390461, 2.35172271416388, 0.474279373222252, 0.0638113874286849, 0.00023465128056279], [15.1431354190985, 1.45379000604814, 0.320835646387801, 0.0404354532094699, 0.00085408113128003]], "La": [[6.09788179599509, 2.19495164736675, 0.548172791960022, 0.0616669573222662, 0.00022680735586471], [12.4288544315854, 1.50535992352023, 0.333738039717124, 0.0387744553499998, 0.00082404988406487]], "Ce": [[5.7952687964724, 2.37022664107843, 0.471398756901114, 0.0574368260587866, 0.00021897948925966], [14.2801055058256, 1.35969015719134, 0.302017349663514, 0.0366436798147007, 0.00079543452651837]], "Pr": [[5.60406255377525, 2.35796259561812, 0.476001098572882, 0.0544123374315247, 0.00021141460220515], [13.9517490230574, 1.31239754917439, 0.294933701192956, 0.0348601542462324, 0.00076826168266181]], "Nd": [[5.4290839196977, 2.3368732536088, 0.483373554104881, 0.0514654964557479, 0.00020377613286376], [13.650364942766, 1.26759841390319, 0.288610681576929, 0.0331291807446609, 0.00074234848380127]], "Pm": [[5.26774445089444, 2.30855813326305, 0.493265479026012, 0.0486356279741696, 0.00019630884232068], [13.3602096827394, 1.22585856586941, 0.282919632127866, 0.0314735397127137, 0.00071765802506962]], "Sm": [[5.12680428517077, 2.2692553400838, 0.504209300453302, 0.0456923992416222, 0.00018867505049389], [13.1581501026129, 1.18129508243337, 0.277107038219062, 0.0297957604549544, 0.0006940110991991]], "Eu": [[4.97962359749809, 2.24183087455669, 0.512933961402893, 0.0429801848498334, 0.00018138169248579], [12.8392663078033, 1.14705446420486, 0.270387160935243, 0.0282418714952602, 0.00067148660317399]], "Gd": [[5.07835830045611, 1.95744027181659, 0.592825983221375, 0.0419502034143925, 0.00017524109152832], [10.5132725469047, 1.11764941281524, 0.284386741833675, 0.0272663327641347, 0.0006503108607073]], "Tb": [[4.711616366573, 2.17261950786578, 0.539717601342865, 0.0379796004547811, 0.00016692376356484], [12.3109415948539, 1.08743796767492, 0.259804965509275, 0.0253289923895189, 0.00062927856696191]], "Dy": [[4.59075504485146, 2.13572373036567, 0.551355560094152, 0.0356058406718513, 0.00015982401685679], [12.0656740623369, 1.05811737115864, 0.253994438918661, 0.0239508739649649, 0.00060948274843329]], "Ho": [[4.4840011062671, 2.08904347078539, 0.565932618316104, 0.0332703590211063, 0.00015244561028289], [11.874925069157, 1.02828493708789, 0.248907807908076, 0.0225844065532147, 0.00059037444515942]], "Er": [[4.37665140786963, 2.04645150383634, 0.580662860591587, 0.0312388528327766, 0.00014537486966254], [11.6653080717139, 1.00314769675495, 0.244153292686312, 0.0213618580000731, 0.00057211033845477]], "Tm": [[4.28308318247419, 1.9953800145373, 0.597053571332504, 0.0290951668869559, 0.00013806476903752], [11.4961905956683, 0.97703910201882, 0.239429132975829, 0.0200912233327255, 0.00055437713849227]], "Yb": [[4.19563840737123, 1.94333285978645, 0.612446617285465, 0.0271515207694932, 0.00013059478735193], [11.4107750456652, 0.949011924454877, 0.234950326535304, 0.0189051576280975, 0.00053723364920971]], "Lu": [[4.35692593296384, 1.69589204777315, 0.66390452006847, 0.0263020018760281, 0.00012549731849982], [9.29434514718568, 0.91050004595742, 0.238746595911376, 0.0182098542546462, 0.00052155937196356]], "Hf": [[4.33138405664923, 1.5276486472868, 0.735795922891238, 0.0249526323201402, 0.00011874085258106], [7.87684433810288, 0.942515642627748, 0.241699480039806, 0.0172899894448509, 0.00050583463131353]], "Ta": [[4.19726001319642, 1.46854806774708, 0.783931248211088, 0.0232494094864395, 0.00011126135860729], [6.93674024894457, 1.01725276618348, 0.23894893971507, 0.0162332433075381, 0.00049023900402115]], "W": [[3.97629715819077, 1.52292684257341, 0.797706246390561, 0.0213666741558685, 0.00010307868938572], [6.29685779228774, 1.11289951157691, 0.231057040678473, 0.0151013545567204, 0.00047468247710503]], "Re": [[3.75144381439811, 1.62768802977632, 0.781756755454271, 0.0195170803912291, 9.431998042934e-05], [5.79754636082953, 1.1822363107771, 0.21991358602477, 0.0139810455481456, 0.00045912712582984]], "Os": [[3.48401517338711, 1.79377920416965, 0.74487835669192, 0.0175427785162434, 8.448723515689e-05], [5.43998846080953, 1.22792134140128, 0.206208856992909, 0.0127899401721146, 0.00044303222678748]], "Ir": [[1.599565781988442, 2.975344521941205, 6.950926783668822e-01, 1.487796274586880e-02, 6.905495791015833e-05], [5.792444473855675, 1.553009829732260, 1.886263359366482e-01, 1.117634706624533e-02, 4.227723616555514e-04]], "Pt": [[2.04021563975728, 2.89922634624825, 0.636344083815797, 0.0132071919595408, 5.673821925001e-05], [6.65819429609627, 1.41337923778932, 0.174000104502179, 0.010068780453021, 0.00040307710569222]], "Au": [[1.6759346706487, 3.00486602969729, 0.595340013161635, 0.0117163186623094, 4.296782976398e-05], [5.52231093211402, 1.38007223007196, 0.162229237655945, 0.00901814890416575, 0.00037927766747767]], "Hg": [[2.23522850443105, 2.68276638651994, 0.555194926212433, 0.0107273354366258, 3.284739920463e-05], [5.0203098896024, 1.23077590583777, 0.152248122992863, 0.0082839911690621, 0.00035624193893176]], "Tl": [[2.8034273741251, 2.7188278796602, 0.522475915391999, 0.00984537836971042, 2.345245265083e-05], [6.55876872804534, 1.16972422516667, 0.143556691800178, 0.00761976526230039, 0.00032962767390299]], "Pb": [[3.60861020997771, 2.45056774737198, 0.478639500107257, 0.00887214235169215, 1.040019329095e-05], [6.58162594621962, 1.02772852660588, 0.13353368063472, 0.00684861238948429, 0.00027638887545667]], "Bi": [[4.24209901057315, 2.09994342055827, 0.432836631379922, 0.00802021570381059, 7.2178503085e-07], [5.7528011553608, 0.873901489195461, 0.123599956180524, 0.0061760033305857, 0.00014149517761723]], "Po": [[4.63620095668962, 1.78063311426987, 0.403730443952738, 0.00768539554668674, 8.954159028e-08], [4.88825299780982, 0.756310526880074, 0.117302364452249, 0.00593034394242894, 7.66668663873e-05]], "At": [[4.9659225059507, 1.43815561507033, 0.371299200579298, 0.00747256428450201, 1.1411528415e-07], [4.09129378787496, 0.629228996602551, 0.111096678695535, 0.00577235010347761, 8.085118938794e-05]], "Rn": [[5.30615614475033, 1.11733160236072, 0.315858723110854, 0.0072034224231021, 1.0735533055e-07], [3.48800735481655, 0.481190741149771, 0.101874467945753, 0.00559245374417078, 7.795066735407e-05]], "Fr": [[4.52053399042336, 4.10695397909124, 0.713946878503728, 0.0169294027687453, 8.574921291917e-05], [19.4482234232948, 1.89824673155996, 0.169553563595341, 0.0114819567548934, 0.00034612203825798]], "Ra": [[6.52401072001873, 3.20787080745661, 0.540478774349637, 0.00878278806898853, 6.91010602949e-06], [14.0092554298974, 1.32635035961665, 0.131408568386036, 0.00628647434520409, 0.00022783998145895]], "Ac": [[6.89602853559619, 2.83514154536523, 0.503506881888815, 0.00802294510966706, 9.204009548e-08], [11.0763825670398, 1.17132616290503, 0.123494651391799, 0.00573515595790497, 7.197075418025e-05]], "Th": [[7.0937490016263, 2.52912373903194, 0.482107819888889, 0.00771936674145111, 7.271141994e-08], [9.09473795165944, 1.06391667033161, 0.118619446621877, 0.00553945708895034, 6.584947305285e-05]], "Pa": [[6.43401324797284, 2.97099970535788, 0.460796651787848, 0.00724033125775455, 6.362366643e-08], [10.2596851307297, 1.13177452306163, 0.112775935362382, 0.00527459583353132, 6.192638240888e-05]], "U": [[6.21070826784019, 3.03934453825623, 0.437339984439162, 0.00680714764147316, 6.182293277e-08], [10.0214105859162, 1.10399880155883, 0.107218973162453, 0.00502432130850682, 6.005069941972e-05]], "Np": [[6.00431598308986, 3.09431654531418, 0.412808487716417, 0.00640891657880066, 6.730073762e-08], [9.81793046719106, 1.06978705068029, 0.101635291448645, 0.00479524846888725, 6.028065987265e-05]], "Pu": [[5.20061716810304, 3.49849440367144, 0.40541493113132, 0.00622343700826529, 6.008593295e-08], [11.2038310194406, 1.12846369546928, 0.0989333472686131, 0.0046591743197795, 5.725906389623e-05]], "Am": [[5.02533860036029, 3.51843988285154, 0.381950349446272, 0.00582110208096211, 6.526093388e-08], [10.9772190697628, 1.0847721483263, 0.0936746874853835, 0.00442682346873485, 5.738568370505e-05]], "Cm": [[5.34656100260619, 3.2246846656091, 0.349461752625445, 0.00529251756748815, 6.159176302e-08], [9.23118379752449, 0.972836229193835, 0.0870596220966562, 0.00413011964465032, 5.494638944497e-05]], "Bk": [[5.22582350334004, 3.22818873995295, 0.327098878823851, 0.00488882575592239, 5.212722694e-08], [9.07135706618718, 0.931124277456634, 0.0820720602059845, 0.00389029655993416, 5.103679766366e-05]], "Cf": [[4.58641247753547, 3.51869595665101, 0.319261714201205, 0.00472979647985625, 5.513244808e-08], [10.3186102092335, 0.957278837829232, 0.079680743144388, 0.00377193199996848, 5.09750860376e-05]], "Es": [[4.45799480675412, 3.50867212637662, 0.301375380528315, 0.00440763746214481, 4.887879032e-08], [10.0890693383401, 0.919446447361622, 0.0756419177786329, 0.00357026465124809, 4.804951743958e-05]], "Fm": [[4.3389757640117, 3.49185098896403, 0.281471099016286, 0.00400209271499046, 5.529298082e-08], [9.96330937223836, 0.878083956982974, 0.0711637115768777, 0.00332152404215077, 4.851031794604e-05]], "Md": [[4.22729470403101, 3.47249227510661, 0.264822229496898, 0.00369072877833192, 6.258714262e-08], [9.72400602040031, 0.84287377596021, 0.0673534743974851, 0.0031236460626332, 4.912170970176e-05]], "No": [[4.1095170244302, 3.4579913252275, 0.247087351222386, 0.00330423920940995, 5.991049262e-08], [9.6773599451012, 0.806940042470817, 0.0632815436954167, 0.00287544639641209, 4.706791536976e-05]], "Lr": [[4.52147421198378, 3.20212985587804, 0.223028726956451, 0.00281716453892029, 4.06427954e-08], [8.28309906861142, 0.731918958125393, 0.0580942773018655, 0.00256168016047444, 4.03816515529e-05]]}


def electron_scattering_factor(k2, params):
    """
    Compute electron scattering factor using Lobato parametrization.
    
    Parameters
    ----------
    k2 : float or ndarray
        Squared scattering vector magnitude (in 1/Angstrom^2)
    params : ndarray
        Lobato parameters [2 x 5] array where params[0] are 'a' coefficients
        and params[1] are 'b' coefficients
        
    Returns
    -------
    f : float or ndarray
        Electron scattering factor
        
    Notes
    -----
    Based on Lobato & Van Dyck (2014), Acta Cryst. A70, 636-649
    f_e(k^2) = sum_i [ a_i * (2 + b_i * k^2) / (1 + b_i * k^2)^2 ]
    """
    p = np.array(params, dtype=np.float64)
    # Vectorized computation over all 5 terms
    k2 = np.asarray(k2)
    result = np.zeros_like(k2, dtype=np.float64)
    for i in range(5):
        result += (p[0, i] * (2.0 + p[1, i] * k2) / 
                   (1.0 + p[1, i] * k2) ** 2)
    return result


def x_ray_scattering_factor(k, params):
    """
    Compute X-ray scattering factor using Lobato parametrization.
    
    Parameters
    ----------
    k : float or ndarray
        Scattering vector magnitude (in 1/Angstrom)
    params : ndarray
        Lobato parameters [2 x 5] array
        
    Returns
    -------
    f : float or ndarray
        X-ray scattering factor
        
    Notes
    -----
    Uses Bohr radius conversion: 1 Bohr = 0.529177 Angstrom
    Based on Lobato & Van Dyck (2014), Acta Cryst. A70, 636-649
    f_xray(k) = sum_i [ 2*pi^2*a0 * a_i / (b_i * (1 + b_i * k^2)^2) ]
    where a0 is the Bohr radius in Angstrom
    """
    BOHR_TO_ANGSTROM = 0.529177210903
    p = np.array(params, dtype=np.float64)
    k = np.asarray(k)
    k2 = k**2
    result = np.zeros_like(k, dtype=np.float64)
    for i in range(5):
        result += (2 * np.pi**2 * BOHR_TO_ANGSTROM * p[0, i] / 
                   (p[1, i] * (1 + p[1, i] * k2) ** 2))
    return result


def compute_scattering_profile(elements, s_values, xray=False):
    """
    Compute scattering factor profiles for multiple elements.
    
    Parameters
    ----------
    elements : list of str
        List of element symbols (e.g., ['Au', 'C'])
    s_values : ndarray
        Scattering vector magnitudes in 1/Angstrom (s = sin(theta)/lambda)
    xray : bool, optional
        If True, compute X-ray scattering factors. If False (default),
        compute electron scattering factors.
        
    Returns
    -------
    profiles : ndarray
        Array of shape (n_elements, n_points) with scattering profiles
    """
    n_elements = len(elements)
    n_points = len(s_values)
    profiles = np.zeros((n_elements, n_points), dtype=np.float64)
    
    for i, element in enumerate(elements):
        if element not in LOBATO_PARAMETERS:
            raise ValueError(f"Element '{element}' not found in Lobato parameters")
        
        params = LOBATO_PARAMETERS[element]
        
        if xray:
            # For X-rays: f(k) where k = s
            profiles[i] = x_ray_scattering_factor(s_values, params)
        else:
            # For electrons: f(k^2) where k^2 = s^2
            # This is vectorized now
            k2_values = s_values**2
            profiles[i] = electron_scattering_factor(k2_values, params)
            # For electrons: use k^2 = s^2
            k2_values = s_values**2
            profiles[i] = np.array([electron_scattering_factor(k2, params) 
                                   for k2 in k2_values])
    
    return profiles


class LobatoScatteringCalculator:
    """
    Calculator for electron and X-ray scattering factors using Lobato parametrization.
    
    This provides a simplified interface similar to abtem's LobatoParametrization.
    """
    
    def __init__(self):
        self.parameters = LOBATO_PARAMETERS
    
    def line_profiles(self, elements, cutoff, sampling, name="scattering_factor"):
        """
        Compute scattering factor line profiles.
        
        Parameters
        ----------
        elements : list of str
            Element symbols
        cutoff : float
            Maximum s value (1/Angstrom)
        sampling : float
            Sampling interval in s (1/Angstrom)
        name : str, optional
            Type of scattering factor: "scattering_factor" for electrons,
            "x_ray_scattering_factor" for X-rays
            
        Returns
        -------
        result : SimpleNamespace
            Object with 'array' attribute containing profiles of shape 
            (n_elements, n_points)
        """
        from types import SimpleNamespace
        
        # Generate s grid
        n_points = int(np.ceil(cutoff / sampling))
        s_values = np.arange(n_points) * sampling
        
        # Determine if X-ray or electron
        xray = (name == "x_ray_scattering_factor")
        
        # Compute profiles
        profiles = compute_scattering_profile(elements, s_values, xray=xray)
        
        # Return in a format compatible with abtem's return structure
        result = SimpleNamespace(array=profiles)
        return result
    
    def get_parameters(self, element):
        """Get Lobato parameters for a specific element."""
        if element not in self.parameters:
            raise ValueError(f"Element '{element}' not found")
        return np.array(self.parameters[element])
